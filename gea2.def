BootStrap: docker
From: ubuntu:22.04

%files
  /home/aaron/singfiles/shovill/trimmomatic /bin
  /home/aaron/singfiles/shovill/shovill /bin
  /home/aaron/singfiles/sge.sh /usr/local/src
  /home/aaron/singfiles/slurm.sh /usr/local/src
  /home/aaron/singfiles/metaclean.R /usr/local/src
  /home/aaron/singfiles/changenames.sh /usr/local/src

%environment
  export LC_ALL=C
  export PATH="$PATH:/usr/src/fimtyper"
  export PATH="$PATH:/bin/bbmap"
  
%post
  ln -sf /usr/share/zoneinfo/America/Chicago /etc/localtime && apt -y -qq update && apt -y -qq upgrade && apt -y -qq install locales && locale-gen \
  en_US.UTF-8 && update-locale LC_ALL=en_US.UTF-8 && LANG=en_US.UTF-8apt && apt -y -qq update && apt -y -qq install cpanminus python3-pip python-is-python3 g++ cmake \
  libbz2-dev wget zlib1g-dev git skesa megahit velvet lighter flash samtools bwa kmc seqtk pigz default-jre pilon trimmomatic samclip ncbi-blast+ bc kma \
  python3.10-venv && apt -y -qq install --no-install-recommends r-base && rm -rf /var/cache/apt/* /var/lib/apt/lists/* && wget \
  http://cab.spbu.ru/files/release3.15.5/SPAdes-3.15.5.tar.gz && tar -xzf SPAdes-3.15.5.tar.gz && cd SPAdes-3.15.5 && PREFIX=/usr/local ./spades_compile.sh && cd .. && rm \
  -rf SPA* && cd /usr/src && git clone https://bitbucket.org/genomicepidemiology/fimtyper.git && cd fimtyper && make install && cd /usr/src && git clone \
  https://github.com/tseemann/shovill.git && cd /bin && wget https://sourceforge.net/projects/bbmap/files/BBMap_39.01.tar.gz/download && tar zxvf download && rm download
	
%help
This container was built on August 17, 2023 on the ubuntu jammy (22.0.4) operating system using the command sudo apptainer build geacont4 gea2.def.
This container contains SPAdes (version 3.15), blast (version 2.12), skesa (version 2.4), shovill (version 1.1), fimtyper (version 1.1),
resfinder (version 4.3), mlst, virulencefinder, serotypefinder, plasmidfinder, ezclermont (version 0.7), and SeqSero2 (version 1.1)
The software in this container can run the end-to-end Gammaproteobacteria epidemiologic annotation bash (GEAbash) pipeline. It can also
update custom BLAST and Center for Genomic Epidemiology (CGE) databases.
To get this help message type 'singularity run-help rnaseq_cont' without quotes
To get help with constituent programs used in the pipeline, type the following without quotes:
'singularity exec geacont4 fimtyper.pl -h'
'singularity exec geacont4 shovill -h'
'singularity exec geacont4 blastn -h'
'singularity exec geacont4 skesa -h'
'singularity exec --app cge geacont4 mlst.py -h'
'singularity exec --app cge geacont4 virulencefinder.py -h'
'singularity exec --app cge geacont4 serotypefinder.py -h'
'singularity exec --app cge geacont4 plasmidfinder.py -h'
'singularity exec --app resfinder geacont4 python3 -m resfinder -h'
'singularity exec --app clermont geacont4 ezclermont -h'
'singularity exec --app seqsero geacont4 SeqSero2_package.py -h'

%labels
  Author phylloxera

##############################
# resfinder
##############################

%appinstall resfinder
  cd /opt && python3 -m venv resfinder_env && . /opt/resfinder_env/bin/activate && /opt/resfinder_env/bin/pip3 install resfinder

%appenv resfinder
  . /opt/resfinder_env/bin/activate

##############################
# clermont
##############################

%appinstall clermont
  cd /opt && python3 -m venv clermont_env && git clone https://github.com/nickp60/ezclermont && cd ezclermont && . /opt/clermont_env/bin/activate &&
  /opt/clermont_env/bin/pip3 install . && cd /opt && rm -r ezclermont

%appenv clermont
  . /opt/clermont_env/bin/activate
  
##############################
# seqsero
##############################

%appinstall seqsero
  cd /opt && python3 -m venv seqsero_env && git clone https://github.com/denglab/SeqSero2.git && cd SeqSero2 && . /opt/seqsero_env/bin/activate &&
  /opt/seqsero_env/bin/pip3 install . && cd /opt && rm -r SeqSero2

%appenv seqsero
  . /opt/seqsero_env/bin/activate
  
##############################
# cge
##############################

%appinstall cge
  cd /opt && python3 -m venv cge_env && git clone  https://bitbucket.org/genomicepidemiology/serotypefinder.git && git clone \
  https://bitbucket.org/genomicepidemiology/mlst.git && git clone https://bitbucket.org/genomicepidemiology/plasmidfinder.git && git clone \
  https://bitbucket.org/genomicepidemiology/virulencefinder.git && . /opt/cge_env/bin/activate && /opt/cge_env/bin/pip3 install biopython tabulate cgecore

%appenv cge
  . /opt/cge_env/bin/activate
  export PATH="$PATH:/opt/serotypefinder"
  export PATH="$PATH:/opt/mlst"
  export PATH="$PATH:/opt/plasmidfinder"
  export PATH="$PATH:/opt/virulencefinder"